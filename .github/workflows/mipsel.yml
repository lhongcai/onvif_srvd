name: Build for MIPSel Linux  
  
on:  
  workflow_dispatch:  
  
jobs:  
  build-mipsel:  
    runs-on: ubuntu-latest  
      
    steps:  
    - name: Checkout code  
      uses: actions/checkout@v4  
        
    - name: Install dependencies  
      run: |  
        sudo apt update  
        sudo apt install -y \  
          cmake \  
          make \  
          m4 \  
          flex \  
          bison \  
          byacc \  
          yacc \  
          gcc-mipsel-linux-gnu \  
          g++-mipsel-linux-gnu \  
          libc6-dev-mipsel-cross \  
          linux-libc-dev-mipsel-cross \  
          gsoap \  
          libgsoap-dev  
            
    - name: Verify toolchain  
      run: |  
        mipsel-linux-gnu-gcc --version  
        which wsdl2h  
        which soapcpp2  
          
    - name: Configure CMake for MIPSel  
      run: |  
        cmake -B build-mipsel \  
          -DCMAKE_BUILD_TYPE=Release \  
          -DCMAKE_SYSTEM_NAME=Linux \  
          -DCMAKE_SYSTEM_PROCESSOR=mipsel \  
          -DCMAKE_C_COMPILER=mipsel-linux-gnu-gcc \  
          -DCMAKE_CXX_COMPILER=mipsel-linux-gnu-g++ \  
          -DCMAKE_FIND_ROOT_PATH=/usr/mipsel-linux-gnu \  
          -DCMAKE_FIND_ROOT_PATH_MODE_PROGRAM=NEVER \  
          -DCMAKE_FIND_ROOT_PATH_MODE_LIBRARY=ONLY \  
          -DCMAKE_FIND_ROOT_PATH_MODE_INCLUDE=ONLY \  
          -DUSE_SYSTEM_GSOAP=1 \  
          -DUSE_GSOAP_STATIC_LIB=1  
            
    - name: Build  
      run: |  
        cmake --build build-mipsel --verbose  
          
    - name: Check binary  
      run: |  
        if [ -f build-mipsel/onvif_srvd ]; then  
          file build-mipsel/onvif_srvd  
          ls -la build-mipsel/onvif_srvd  
        else  
          echo "Build failed"  
          find build-mipsel -name "*.log" -exec cat {} \;  
          exit 1  
        fi
