name: Build for MIPSel Linux  
  
on:  
  workflow_dispatch:  
  
jobs:  
  build-mipsel:  
    runs-on: ubuntu-latest  
      
    steps:  
    - name: Checkout code  
      uses: actions/checkout@v4  
        
    - name: Install dependencies  
      run: |  
        sudo apt update  
        sudo apt install -y \  
          cmake \  
          make \  
          m4 \  
          flex \  
          bison \  
          byacc \  
          yacc \  
          wget \  
          unzip \  
          patch \  
          gcc-mipsel-linux-gnu \  
          g++-mipsel-linux-gnu \  
          libc6-dev-mipsel-cross \  
          linux-libc-dev-mipsel-cross  
            
    - name: Pre-download gSOAP  
      run: |  
        mkdir -p SDK  
        wget -O SDK/gsoap_2.8.92.zip \  
          https://github.com/SrcBackup/gsoap/releases/download/v2.8.x/gsoap_2.8.92.zip || \  
        wget -O SDK/gsoap_2.8.92.zip \  
          https://sourceforge.net/projects/gsoap2/files/gsoap_2.8.92.zip/download  
          
    - name: Configure CMake for MIPSel  
      run: |  
        cmake -B build-mipsel \  
          -DCMAKE_BUILD_TYPE=Release \  
          -DCMAKE_SYSTEM_NAME=Linux \  
          -DCMAKE_SYSTEM_PROCESSOR=mipsel \  
          -DCMAKE_C_COMPILER=mipsel-linux-gnu-gcc \  
          -DCMAKE_CXX_COMPILER=mipsel-linux-gnu-g++ \  
          -DCMAKE_FIND_ROOT_PATH=/usr/mipsel-linux-gnu \  
          -DCMAKE_FIND_ROOT_PATH_MODE_PROGRAM=NEVER \  
          -DCMAKE_FIND_ROOT_PATH_MODE_LIBRARY=ONLY \  
          -DCMAKE_FIND_ROOT_PATH_MODE_INCLUDE=ONLY \  
          -DUSE_SYSTEM_GSOAP=0 \  
          -DCMAKE_VERBOSE_MAKEFILE=ON  
            
    - name: Build with verbose output  
      run: |  
        cmake --build build-mipsel --verbose --parallel 1  
          
    - name: Check build result  
      run: |  
        if [ -f build-mipsel/onvif_srvd ]; then  
          file build-mipsel/onvif_srvd  
          ls -la build-mipsel/onvif_srvd  
        else  
          echo "Build failed - binary not found"  
          exit 1  
        fi
